# jpegHDF5

## HDF5 compression filter for JPEG compression.  
  * This is a lossy compression filter.  
  * It provides a user-specified "quality factor" to control the trade-off of size versus accuracy.
  * The officially assigned HDF5 filter number for this filter is 32019.

## Author
  * Mark Rivers, University of Chicago (rivers@cars.uchicago.edu)

## Requirements
  * libjpeg   This library is available as a package for most Linux distributions, and source code is available from https://www.ijg.org/.

## Filter parameters
  * When compressing H5Pset_filter must be called with cd_nelmts=4 and cd_values as follows:
    * cd_values[0] = quality factor (1-100)
    * cd_values[1] = numColumns
    * cd_values[2] = numRows
    * cd_values[3] = 0=Mono, 1=RGB
 
## Restrictions
  * Only 8-bit unsigned data arrays are supported.
  * Arrays must be either:
    * 2-D monochromatic [NumColumns, NumRows] 
    * 3-D RGB [3, NumColumns, NumRows]
  * Chunking must be set to the size of one entire image so the filter is called once for each image.

## Installing the JPEG filter plugin
Instead of just linking this JPEG filter into your HDF5 application, it is possible to install
it as a system-wide HDF5 plugin (with HDF5 1.8.11 or later).  This is useful because it allows
*every* HDF5-using program on your system to transparently read JPEG-compressed HDF5 files.

As described in the [HDF5 plugin documentation](<https://www.hdfgroup.org/HDF5/doc/Advanced/DynamicallyLoadedFilters/HDF5DynamicallyLoadedFilters.pdf>), 
you just need to compile the JPEG plugin into a shared library and
copy it to the plugin directory (which defaults to ``/usr/local/hdf5/lib/plugin`` on non-Windows systems).
You can also install in any other location and define the environment variable HDF5_PLUGIN_PATH to point to that directory.

Following the ``cmake`` instructions below produces a ``libjpeg_h5plugin.so`` shared library 
file (or ``.dylib``/``.dll`` on Mac/Windows), that you can copy to the HDF5 plugin directory.

To *write* JPEG-compressed HDF5 files, on the other hand, an HDF5 using program must be
specially modified to enable the JPEG filter when writing HDF5 datasets, as described below.


Linking the JPEG filter directly into your program
==================================================
Instead of (or in addition to) installing the JPEG plugin system-wide as
described above, you can also link the JPEG filter directly into your
application.  Although this only makes the JPEG filter available in
your application (as opposed to other HDF5-using applications), it
is useful in cases where installing the plugin is inconvenient.  Compile
the JPEG filter as described above, but link ``libjpeg_h5filter.so``
(generated by ``make``) directly into your program.

In order to register JPEG in your HDF5 application, you then need
to call a function in jpeg_h5filter.h, with the following signature::

    int jpeg_register_h5filter()

Calling this will register the filter with the HDF5 library.

A non-negative return value indicates success.  If the registration
fails, an error is pushed onto the current error stack and a negative
value is returned.

An example C program ('src/example.c') is included which demonstrates
the proper use of the filter.  It takes a single optional argument, which
is the JPEG quality factor.  If it is omitted, 100 is used.

This filter has been tested against HDF5 versions 1.10.1.

Using the JPEG filter in your application
=========================================

Assuming the filter is installed (either by a system-wide plugin or registered
directly in your program as described above), your application can transparently
*read* HDF5 files with JPEG-compressed datasets.  (The HDF5 library will detect
that the dataset is JPEG-compressed and invoke the filter automatically).

To *write* an HDF5 file with a JPEG-compressed dataset, you call the
[H5Pset_filter](https://www.hdfgroup.org/HDF5/doc/RM/RM_H5P.html#Property-SetFilter) function
on the property list of the dataset you are creating, and pass ``JPEG_H5FILTER``
(defined in ``jpeg_h5filter.h``) for the ``filter_id`` parameter.   In addition, HDF5
only supports compression for "chunked" datasets; this just means that you need to
call [H5Pset_chunk](https://www.hdfgroup.org/HDF5/doc/RM/RM_H5P.html#Property-SetChunk) to
specify a chunk size.  The chunking must be set to the size of a single image for the JPEG filter to
work properly.

Compiling
=========
The filter consists of a single 'src/jpeg_h5filter.c' source file and
'src/jpeg_h5filter.h' header, which will need the JPEG library
installed to work. The JPEG library needs to be installed on your system.

Assuming you have [cmake](http://www.cmake.org/) and other standard
Unix build tools installed, do
```
    mkdir build
    cd build
    cmake ..
    make
```
There is also a `build_linux` script in the top-level directory.  It does the above
steps (except mkdir build) and passes flags to cmake to define the locations of the hdf5
and jpeg libraries on your system.  You will  

This generates the library/plugin files required above in the ``build``
directory.

Acknowledgments
===============
The cmake file and this documentation borrow heavily from the [hdf-blosc repository](https://github.com/Blosc/hdf5-blosc).
